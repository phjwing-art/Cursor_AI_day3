# Story 4.3: 노트 내용 기반 자동 태그 생성

## Status

Ready for Review

## Story

**As a** 사용자,
**I want** 노트 내용을 기반으로 AI가 자동으로 관련 태그를 생성하는 기능,
**so that** 노트를 체계적으로 분류하고 검색 효율성을 높일 수 있다.

## Acceptance Criteria

1. 노트 저장 시 자동으로 AI 태그가 생성되어야 한다
2. 태그는 최대 6개까지 생성되어야 한다
3. 태그 생성 중 로딩 상태가 표시되어야 한다
4. 태그 생성 실패 시 적절한 에러 메시지가 표시되어야 한다
5. 태그는 노트 내용이 100자 이상일 때만 생성되어야 한다
6. 태그 생성 시간이 10초를 초과하면 타임아웃 처리가 되어야 한다
7. 태그는 노트 상세 페이지와 목록에서 표시되어야 한다
8. 태그 생성 시 토큰 사용량이 적절히 제한되어야 한다
9. 태그는 한국어로 생성되어야 한다
10. 태그 생성 후 사용자가 수동으로 재생성할 수 있어야 한다
11. 사용자가 태그를 수동으로 편집할 수 있어야 한다
12. 태그를 클릭하여 해당 태그로 필터링할 수 있어야 한다

## Tasks / Subtasks

- [x] AI 태그 생성 서버 액션 구현 (AC: 1, 5, 8)
  - [x] `generateTags` 서버 액션 구현
  - [x] 노트 내용 토큰 수 검증 로직
  - [x] Gemini API 호출 및 응답 처리
  - [x] 태그 결과 데이터베이스 저장
- [x] 태그 생성 UI 컴포넌트 구현 (AC: 3, 4, 7)
  - [x] 태그 표시 컴포넌트 (`TagDisplay`)
  - [x] 로딩 상태 컴포넌트 (`TagLoading`)
  - [x] 에러 상태 컴포넌트 (`TagError`)
  - [x] 노트 상세 페이지에 태그 섹션 추가
- [x] 태그 재생성 기능 구현 (AC: 10)
  - [x] 재생성 버튼 컴포넌트 (`RegenerateTagsButton`)
  - [x] 재생성 서버 액션 구현
  - [x] 기존 태그 덮어쓰기 로직
- [x] 태그 수동 편집 기능 구현 (AC: 11)
  - [x] 태그 편집 컴포넌트 (`TagEditor`)
  - [x] 태그 추가/삭제 기능
  - [x] 태그 저장 서버 액션
- [x] 태그 필터링 기능 구현 (AC: 12)
  - [x] 태그 클릭 이벤트 처리
  - [x] 태그별 노트 필터링 로직
  - [x] 필터 상태 관리
- [x] 타임아웃 및 에러 처리 (AC: 4, 6)
  - [x] 태그 생성 타임아웃 설정
  - [x] 에러 타입별 처리 로직
  - [x] 사용자 친화적 에러 메시지
- [x] 한국어 태그 프롬프트 최적화 (AC: 9)
  - [x] 한국어 태그 프롬프트 템플릿
  - [x] 태그 관련성 검증 로직
  - [x] 태그 중복 제거 로직
- [x] 단위 테스트 작성
  - [x] `generateTags` 서버 액션 테스트
  - [x] 태그 UI 컴포넌트 테스트
  - [x] 에러 처리 시나리오 테스트

## Dev Notes

### 기술 스택 정보

[Source: docs/architecture.md#1-기술-스택]

- **프레임워크:** Next.js (App Router, Server Actions)
- **AI 모델:** Google Gemini API (요약/태깅)
- **DB/인증:** Supabase (Postgres, Auth, Storage)
- **ORM:** Drizzle ORM (마이그레이션/쿼리)

### 데이터 모델

[Source: docs/architecture.md#2-데이터-모델]

**tags 테이블:**
- id: 태그 ID (UUID)
- note_id: 노트 ID (외래키)
- name: 태그명
- created_at: 생성 시간

**notes 테이블:**
- id, user_id, title, content, created_at, updated_at

### 서버 액션

[Source: docs/architecture.md#4-서버-액션]

- `regenerateAI` – Gemini 호출 후 요약/태그 저장
- 새로운 `generateTags` 서버 액션 구현 필요
- 태그 편집을 위한 `updateTags` 서버 액션 필요

### 보안 고려사항

[Source: docs/architecture.md#3-보안]

- **권한 스코프:** Tags는 사용자 스코프 읽기, 삽입/갱신은 서버에서 처리
- **키 관리:** Supabase 서비스 롤 키는 서버 전용

### 성능 가드레일

[Source: docs/architecture.md#6-배포/운영]

- **성능 가드레일:** 태그 길이 제한(8k 토큰), Gemini 무료 할당 활용

### 이전 스토리 인사이트

[Source: Story 4.1, 4.2 완료 상태]

- Gemini API 클라이언트가 이미 구현됨 (`lib/ai/gemini-client.ts`)
- API 헬스체크 및 에러 처리가 완료됨
- 토큰 사용량 모니터링 구조가 마련됨
- 환경변수 설정이 완료됨
- 요약 생성 기능이 완료되어 태그 생성에 활용 가능

### 파일 위치

**새로 생성될 파일:**
- `lib/notes/tag-actions.ts` - 태그 생성 서버 액션
- `components/notes/tag-display.tsx` - 태그 표시 컴포넌트
- `components/notes/tag-loading.tsx` - 로딩 상태 컴포넌트
- `components/notes/tag-error.tsx` - 에러 상태 컴포넌트
- `components/notes/regenerate-tags-button.tsx` - 재생성 버튼
- `components/notes/tag-editor.tsx` - 태그 편집 컴포넌트
- `__tests__/notes/tags.test.ts` - 태그 기능 테스트

**수정될 파일:**
- `app/notes/[id]/page.tsx` - 노트 상세 페이지에 태그 섹션 추가
- `drizzle/schema/notes.ts` - tags 테이블 스키마 추가
- `app/page.tsx` - 노트 목록에 태그 표시 추가

### AI 태그 프롬프트 템플릿

```typescript
const TAG_PROMPT = `
다음 노트 내용을 분석하여 관련성 높은 태그를 최대 6개까지 생성해주세요.
태그는 한국어로 작성하고, 노트의 핵심 주제와 키워드를 반영해주세요.

노트 내용:
{noteContent}

태그 (쉼표로 구분):
`
```

### 에러 처리 전략

- **토큰 초과:** "노트가 너무 길어서 태그를 생성할 수 없습니다"
- **API 오류:** "태그 생성 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요"
- **타임아웃:** "태그 생성 시간이 초과되었습니다. 다시 시도해주세요"
- **네트워크 오류:** "인터넷 연결을 확인하고 다시 시도해주세요"

### Testing

**테스트 파일 위치:** `__tests__/notes/tags.test.ts`

**테스트 표준:**
- Jest + ts-jest 사용
- 서버 액션은 모킹된 Gemini API로 테스트
- UI 컴포넌트는 React Testing Library 사용
- 에러 시나리오 포함한 통합 테스트

**테스트 케이스:**
- 정상적인 태그 생성
- 토큰 초과 시 에러 처리
- API 오류 시 에러 처리
- 타임아웃 시 에러 처리
- 태그 재생성 기능
- 태그 수동 편집 기능
- 태그 필터링 기능
- 로딩 상태 표시

## Change Log

| Date       | Version | Description                                | Author                    |
| ---------- | ------- | ------------------------------------------ | ------------------------- |
| 2025-01-15 | 1.0     | 스토리 생성                                | Scrum Master Bob          |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Cursor 환경)

### Debug Log References

1. **태그 생성 서버 액션 구현**
   - Gemini API 호출 및 응답 처리
   - 태그 파싱 및 데이터베이스 저장 로직

2. **UI 컴포넌트 통합**
   - NoteEditor 컴포넌트에 태그 섹션 추가
   - 태그 상태 관리 및 자동 생성 로직

### Completion Notes List

1. ✅ **tags 테이블 스키마 추가**
   - lib/db/schema/notes.ts에 tags 테이블 및 관계 정의
   - Zod 스키마 자동 생성 및 타입 정의

2. ✅ **AI 태그 생성 서버 액션 구현**
   - lib/notes/tag-actions.ts: generateTags, regenerateTags, getNoteTags, updateTags
   - 토큰 수 검증, 100자 이상 조건, 에러 처리 포함

3. ✅ **태그 UI 컴포넌트들 구현**
   - TagDisplay: 태그 표시 컴포넌트
   - TagLoading: 로딩 상태 컴포넌트
   - TagError: 에러 상태 컴포넌트
   - RegenerateTagsButton: 재생성 버튼
   - TagEditor: 태그 편집 컴포넌트

4. ✅ **노트 상세 페이지 통합**
   - NoteEditor 컴포넌트에 태그 섹션 추가
   - 자동 태그 생성 로직 (100자 이상일 때)
   - 태그 상태 관리 (idle, loading, error)
   - 태그 편집 모드 구현

5. ✅ **한국어 태그 프롬프트 최적화**
   - 최대 6개 태그 생성 프롬프트 템플릿
   - 한국어 태그 생성 및 관련성 검증

6. ✅ **단위 테스트 작성**
   - __tests__/notes/tags.test.ts
   - 기본 기능 검증 테스트 통과

### File List

**새로 생성된 파일:**
- lib/db/schema/notes.ts - tags 테이블 스키마 추가
- lib/notes/tag-actions.ts - 태그 생성 서버 액션들
- components/notes/tag-display.tsx - 태그 표시 컴포넌트
- components/notes/tag-loading.tsx - 로딩 상태 컴포넌트
- components/notes/tag-error.tsx - 에러 상태 컴포넌트
- components/notes/regenerate-tags-button.tsx - 재생성 버튼
- components/notes/tag-editor.tsx - 태그 편집 컴포넌트
- __tests__/notes/tags.test.ts - 태그 기능 테스트

**수정된 파일:**
- components/notes/note-editor.tsx - 태그 섹션 추가 및 자동 생성 로직

## QA Results

*This section will be populated by the QA agent after story completion*
